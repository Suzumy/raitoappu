# Here's a LIBC
## picoCTF2021
## Binary Exploition
***

ファイルが配布されるため、まずvulnから見ていく  
> file ./vuln
```
./vuln: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=e5dba3e6ed29e457cd104accb279e127285eecd0, not stripped
```
どうやら64bitで実行可能のようなので、一旦実行してみる。  
```
$ ./vuln
WeLcOmE To mY EcHo sErVeR!
aaa
AaA
abab
AbAb
bbb
BbB
^C
```
二文字に一回大文字小文字を変換するプログラムっぽい。  
BOFが可能か調べてみる  
```
$ ./vuln
WeLcOmE To mY EcHo sErVeR!
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
AaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaaaaaaaaaaaaaaaaaaaaad
Segmentation fault (core dumped)
```
セグフォが発生したので、どこかにBOFがあることが分かる。  
次に何文字でセグフォが発生するのか(オフセット)を調べる。  

まずgdbを起動する
> gdb ./vuln

次にpattcで200文字生成する
```
gdb-peda$ pattc 200
'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA'
```
プログラムを実行する
> gdb-peda$ run

生成された文字列をコピーして、入力のタイミングで張り付ける
```
gdb-peda$ r
Starting program: /home/suzumy/vuln
WeLcOmE To mY EcHo sErVeR!
AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA
AaA%AaSaAbAa$aAnAaCaA-Aa(aAdAa;aA)AaEaAaAa0aAfAaBaA1AaGaAcAa2aAhAaDaA3AaIaAeAa4aAjAaFaA5AaKaAgAa6aAlAAhAA7AAMAAiAA8AANAAd

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x7a ('z')
RBX: 0x0
RCX: 0x0
RDX: 0x7fffff3ed8c0 --> 0x0
RSI: 0x7fffff3ec7e3 --> 0x3ed8c0000000000a
RDI: 0x1
RBP: 0x6c41415041416b41 ('AkAAPAAl')
RSP: 0x7ffffffee028 ("AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
RIP: 0x400770 --> 0x415741e5894855c3
R8 : 0x79 ('y')
R9 : 0x0
R10: 0x0
R11: 0x0
R12: 0x1b
R13: 0x0
R14: 0x1b
R15: 0x0
EFLAGS: 0x10202 (carry parity adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x400769 <do_stuff+145>:     call   0x400540 <puts@plt>
   0x40076e <do_stuff+150>:     nop
   0x40076f <do_stuff+151>:     leave
=> 0x400770 <do_stuff+152>:     ret
   0x400771 <main>:     push   rbp
   0x400772 <main+1>:   mov    rbp,rsp
   0x400775 <main+4>:   push   r15
   0x400777 <main+6>:   push   r14
[------------------------------------stack-------------------------------------]
0000| 0x7ffffffee028 ("AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| 0x7ffffffee030 ("RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| 0x7ffffffee038 ("ApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| 0x7ffffffee040 ("AAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0032| 0x7ffffffee048 ("VAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0040| 0x7ffffffee050 ("AuAAXAAvAAYAAwAAZAAxAAyA")
0048| 0x7ffffffee058 ("AAYAAwAAZAAxAAyA")
0056| 0x7ffffffee060 ("ZAAxAAyA")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000400770 in do_stuff ()
```
Segmentation fault.と表示され、プログラムが停止した。　　
ここからオフセットを探す  
スタックの一番上を見ると、
> 0000| 0x7ffffffee028 ("AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")

となっているため、文字列のAAQAが何文字目かわかればオフセットがわかる。
pattoを使ってオフセットを調べる
```
gdb-peda$ patto AAQA
AAQA found at offset: 136
```
オフセットが136文字であることが分かった。

