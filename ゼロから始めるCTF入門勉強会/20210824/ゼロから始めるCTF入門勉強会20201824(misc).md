# fly
## 始めて学ぶバイナリ解析(ctf4b)
## misc
***

始めに圧縮ファイルが渡されるため、それを解凍する。
> tar -zxvf fly.tar.gz

中を見るといくつかのファイルがあり、game.exeというファイルも渡される。これをまずは実行してみる。  

実行すると、死神がハニワと一緒に枠の中に閉じ込められている状態になっている。横に階段っぽいのがあるので、ここに入ってみたいが、枠から出ることが出来ない。まずはこの枠からでることを目標にする。  

今回はうさみみハリケーンを使ってメモリの値を改ざんし、死神を階段へ導く。  

まずはうさみみハリケーンのUsaMimi32.exeを起動する。メモリを改ざんしたいソフトを選択する画面がでるため、game.exeを選択する。  

するとバイナリエディタが表示される。まずはここから死神を動かすためのパラメータを探す作業を行う.

死神の位置を操作しているのはおそらくx,yの値であると予想できる。ここでは横移動しか出来ないため、まずはxの値を操作しているメモリを探し出す。  

うさみみハリケーンの検索->簡易数値検索を開き、比較方法のところを現在地は不明な値(符号付き)として初回検索を行う。

すると大量の検索結果が出るため、これを絞り込み検索にかける。  

一旦ゲーム画面に戻り、死神を左に少し動かす。左に動かすということは、xの値は0に近づく、つまり減少するということなので、比較方法のところを次は減少したに変更して、絞り込み検索をする。すると一気に値が減る。これを繰り返して、だいたい30~50ぐらいになるまでやる。  

今回は左右への移動のため、普通に考えれば0から始まってそこまで大きくない値の範囲で収まると考えられるため、-の数値や小数の数値、累乗の数値などを省いて、残った値を片っ端から調べていく。

調べ方はまず調べたい値の行をクリックする。するとバイナリエディタの方が連動して同じアドレスに移動してくれるため、そこを右クリック->選択アドレスへの直接書き込み...を選択する。書き込むデータを入力の値のところに適当な数字を入力する。試しに100とか入力する。書き込みを押してゲームに戻る。戻った時に死神の位置が動いていれば成功だが、今回は動いていないため、今回触ったパラメータは死神を左右に動かすものとは違うものだったことがわかる。これが成功するまで片っ端から繰り返す。  

死神を動かすことに成功したら、階段が二つあることが分かる。試しに赤い階段に入ると、地獄みたいなマップが表示される。調べてもflagっぽいものはないので青い方が正解であることがわかる。次に青い方へ進もうとすると、今度は階段に触れても降りられないことに気が付く。どうやらゲームからここにはいることはできないっぽい。  

青い階段に触れたときに起こる処理は
１ー青い階段用のmap情報を用意
２－そのマップにプレイヤーを持っていくイベントを用意
となる。つまり、２のイベントが用意されてないことが予想される。  
しかし、もし青い階段用のマップがきちんと用意されているのであれば、赤い階段にふれたとき、青い階段用のmap情報を表示するように改ざんしてやれば、青い階段の先を見ることができるかもしれない。  
今回のゲームではマップ情報は.mpsという拡張子で保存されているため、これを検索して青い階段用のものもあるか調べてみる。  
次に検索する前に、バイナリデータを一番始めに持っていく。  
移動->表示アドレスを指定を開く。  
モジュール/情報のところがGame.exeになっている場所をクリックし、アドレス変更をクリックする。これで先頭データに戻ってきた。  

次に検索を行う。  
検索->メモリ検索設定を開く  
検索条件に.mpsを選択->文字列をWindows ANSIに変更し、検索実行を行う。すると、flag1.mps、ctf4b.mps、flag2.mpsがみつかる。名前から  
ctf4b - メイン画面のマップ  
flag1 - 赤い階段用  
flag2 - 青い階段用  
と推測できる。ならすべてのflag1のところをflag2に変更してやればいい。  
検索->メモリ検索設定を開く  
検索条件をflag1にする->文字列をWindows ANSIにする->検索実行  
するとバイナリエディタの方で検索された文字列のところへとぶため、ここで右クリック->選択アドレスへの直接書き込み...をクリック->書き込むデータにflag2を入力->Windows ANSIを選択-> 書き込み  
とすると、flag1がflag2に書き変わる。これをflag1が見つからなくなるまで繰り返す。  
検索結果が見つからなくなれば、赤い階段に入ってみる。するとさっきとは打って変わって天国みたいなmapになっている。女の人に話しかけるとよくわからない文字列をいうが、これがフラグになっているため、ctf4bをつけてフラグが完成する。
